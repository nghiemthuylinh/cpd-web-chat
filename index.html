<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CPD Coach ‚Äì Edison (Light)</title>
  <link rel="icon" href="logo.png">
  <style>
    :root{
      /* Edison brand palette */
      --brand:       #0a5a4b;  /* xanh l√° ƒë·∫≠m (primary) */
      --brand-600:   #09604f;  /* hover c·ªßa primary (ƒë·∫≠m h∆°n ch√∫t) */
      --accent-1:    #9baf4b;  /* xanh l√° nh·∫°t */
      --accent-2:    #f05a23;  /* cam ƒë·ªè (n√∫t/nh·∫•n) */
      --accent-3:    #faaf28;  /* cam s√°ng (badge) */
      --accent-4:    #915028;  /* n√¢u ƒë·∫•t */
      --neutral:     #b4b4b4;  /* x√°m trung t√≠nh */

      /* Light mode surfaces */
      --bg:    #f7f9fc;        /* n·ªÅn trang */
      --card:  #ffffff;        /* n·ªÅn khung chat */
      --text:  #0b1220;        /* m√†u ch·ªØ ch√≠nh */
      --muted: #5b6b86;        /* ch·ªØ ph·ª• */

      /* Bubble (t√¥ng s√°ng) */
      --bubble-bot:  #e7f2ef;  /* xanh l√° r·∫•t nh·∫°t */
      --bubble-user: #ffe9e1;  /* cam r·∫•t nh·∫°t */

      --border: #e5e9f0;       /* vi·ªÅn nh·∫π */
      --radius: 16px;
      --shadow: 0 10px 24px rgba(17, 24, 39, .06);
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:920px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:22px}

    /* Header */
    .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .badge{margin-left:auto;padding:6px 10px;border-radius:999px;background:rgba(250,175,40,.18);color:#915a00;font-size:12px;border:1px solid #ffd48c}

    /* Chat area */
    .chat{
      flex:1;background:var(--card);border-radius:var(--radius);
      padding:16px;overflow:auto;border:1px solid var(--border);box-shadow:var(--shadow)
    }
    .msg{display:flex;gap:10px;margin:12px 2px}
    .msg .avatar{
      width:32px;height:32px;border-radius:50%;flex:0 0 32px;
      display:flex;align-items:center;justify-content:center;
      background:#e9eef7;color:#274472;font-weight:700;border:1px solid var(--border)
    }
    .bubble{max-width:75%;padding:12px 14px;border-radius:14px;position:relative;border:1px solid var(--border)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .bot .bubble{background:var(--bubble-bot);border-top-left-radius:6px}
    .user{justify-content:flex-end}
    .user .bubble{background:var(--bubble-user);border-top-right-radius:6px}
    .user .avatar{display:none}
    .tools{display:flex;gap:8px;margin-top:6px}
    .btnx{
      font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:8px;
      background:#f4f7fb;color:#2a3a4f;cursor:pointer
    }
    .btnx:hover{background:#eef2f9}

    /* Input bar */
    .bar{display:flex;gap:10px;margin-top:12px}
    textarea{
      flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:#fff;color:var(--text);resize:vertical;min-height:44px;max-height:160px;
      box-shadow:0 1px 0 rgba(17,24,39,.03) inset
    }
    button.send{
      padding:12px 16px;border-radius:12px;border:1px solid #e7c7bc;cursor:pointer;
      background:var(--accent-2);color:white;font-weight:700;box-shadow:0 2px 0 rgba(0,0,0,.04)
    }
    button.send:hover{background:#d64f1f}
    button:disabled{opacity:.6;cursor:not-allowed}
    .footer{margin-top:12px;font-size:12px;color:var(--muted);text-align:center}

    /* Typing dots */
    .typing{display:inline-block}
    .typing span{display:inline-block;width:6px;height:6px;margin:0 2px;background:#9fb2c9;border-radius:50%;opacity:.6;animation:blink 1.2s infinite}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

    @media (max-width:640px){.bubble{max-width:85%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <img class="logo" src="logo.png" alt="Edison Logo" />
      <div>
        <div class="title">CPD Coach</div>
        <div class="subtitle">Tr·ª£ l√Ω n·ªôi b·ªô Edison v·ªÅ quy tr√¨nh, rubric, timeline, bi·ªÉu m·∫´u CPD.</div>
      </div>
      <div class="badge">Edison ‚Ä¢ Internal</div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="bar">
      <textarea id="inp" placeholder="Nh·∫≠p c√¢u h·ªèi‚Ä¶ (Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng)"></textarea>
      <button id="btn" class="send">G·ª≠i</button>
    </div>
    <div class="footer">¬© Edison Schools ‚Äì CPD Coach. H·ªôi tho·∫°i ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô, API key ƒë∆∞·ª£c b·∫£o v·ªá qua serverless proxy.</div>
  </div>

  <script>
    const ENDPOINT = "/.netlify/functions/chat";
    const $chat = document.getElementById('chat');
    const $inp  = document.getElementById('inp');
    const $btn  = document.getElementById('btn');

    const KEY = 'cpd_chat_history_light';
    const history = JSON.parse(localStorage.getItem(KEY) || '[]');

    function saveHistory(){ localStorage.setItem(KEY, JSON.stringify(history)); }
    function timeStr(iso){ return new Date(iso).toLocaleString(); }
    function esc(s){return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}

    function bubbleHTML(role, content, t){
      const side = role === 'user' ? 'user' : 'bot';
      const ava  = side==='bot' ? `<div class="avatar">A</div>` : `<div class="avatar">U</div>`;
      const tools = side==='bot'
        ? `<div class="tools"><button class="btnx" data-copy="${esc(content)}">Copy</button></div>` : '';
      return `<div class="msg ${side}">${ava}<div><div class="bubble">${content}</div>${tools}<div class="meta">${timeStr(t)}</div></div></div>`;
    }

    function render(){
      $chat.innerHTML = history.map(m => bubbleHTML(m.role, esc(m.content), m.t)).join('');
      $chat.scrollTop = $chat.scrollHeight;
    }
    function addMessage(role, content){
      const item = { role, content, t: new Date().toISOString() };
      history.push(item); saveHistory(); render();
    }
    function showTyping(){
      const t = new Date().toISOString();
      const html = bubbleHTML('assistant', `<span class="typing"><span></span><span></span><span></span></span>`, t);
      $chat.insertAdjacentHTML('beforeend', html);
      $chat.scrollTop = $chat.scrollHeight;
      return t;
    }
    function replaceLastBotBubble(text){
      const nodes = $chat.querySelectorAll('.msg.bot .bubble');
      for(let i=nodes.length-1;i>=0;i--){
        if(nodes[i].innerHTML.includes('typing')){ nodes[i].innerHTML = esc(text); break; }
      }
      $chat.scrollTop = $chat.scrollHeight;
    }

    // Copy-to-clipboard
    $chat.addEventListener('click', e=>{
      const btn = e.target.closest('.btnx');
      if(!btn) return;
      const txt = btn.getAttribute('data-copy') || '';
      navigator.clipboard.writeText(txt).then(()=>{
        btn.textContent='ƒê√£ copy'; setTimeout(()=>btn.textContent='Copy',1200);
      });
    });

    render();
    if (!history.length) {
      addMessage('assistant','Ch√†o b·∫°n üëã M√¨nh l√† CPD Coach Edison (Light). B·∫°n mu·ªën h·ªèi g√¨ v·ªÅ CPD h√¥m nay?');
    }

    async function send(){
      const text = $inp.value.trim();
      if(!text) return;
      $inp.value = ''; $inp.focus(); $btn.disabled = true; $inp.disabled = true;
      addMessage('user', text);
      showTyping();

      try{
        const res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messages: history })
        });
        if(!res.ok) throw new Error('Server tr·∫£ tr·∫°ng th√°i ' + res.status);
        const data = await res.json();
        replaceLastBotBubble(data.reply || '[Kh√¥ng c√≥ ph·∫£n h·ªìi]');
        addMessage('assistant', data.reply || '[Kh√¥ng c√≥ ph·∫£n h·ªìi]');
      }catch(err){
        replaceLastBotBubble('‚ö†Ô∏è L·ªói: ' + err.message);
        addMessage('assistant', '‚ö†Ô∏è L·ªói: ' + err.message);
      }finally{
        $btn.disabled = false; $inp.disabled = false;
      }
    }

    // Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng
    $btn.addEventListener('click', send);
    $inp.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
  </script>
</body>
</html>
