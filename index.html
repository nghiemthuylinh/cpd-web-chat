<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CPD Coach ‚Äì Edison (Light)</title>
  <link rel="icon" href="logo.png">
  <style>
    :root{
      /* Edison brand palette */
      --brand:       #0a5a4b;  /* primary */
      --brand-600:   #09604f;  /* hover of primary */
      --accent-1:    #9baf4b;
      --accent-2:    #f05a23;  /* CTA / user bubble */
      --accent-3:    #faaf28;  /* badge */
      --accent-4:    #915028;
      --neutral:     #b4b4b4;

      /* Light surfaces */
      --bg:    #f7f9fc;
      --card:  #ffffff;
      --text:  #0b1220;
      --muted: #5b6b86;

      /* Bubbles */
      --bubble-bot:  #e7f2ef;  /* very light green */
      --bubble-user: #ffe9e1;  /* very light orange */

      --border: #e5e9f0;
      --radius: 16px;
      --shadow: 0 10px 24px rgba(17, 24, 39, .06);
.message {
    white-space: pre-wrap;     /* gi·ªØ xu·ªëng d√≤ng h·ª£p l√Ω */
    word-break: keep-all;      /* kh√¥ng t·ª± ƒë·ªông b·∫ª t·ª´ */
    overflow-wrap: break-word; /* ch·ªâ ng·∫Øt khi c·∫ßn */
}
.body, .chat-container {
    font-family: 'Candara', 'Cambria', sans-serif;
    font-size: 15px;
    line-height: 1.5;
}

    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:920px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:22px}

    /* Header */
    .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .badge{margin-left:auto;padding:6px 10px;border-radius:999px;background:rgba(250,175,40,.18);color:#915a00;font-size:12px;border:1px solid #ffd48c}

    /* Chat area */
    .chat{
      flex:1;background:var(--card);border-radius:var(--radius);
      padding:16px;overflow:auto;border:1px solid var(--border);box-shadow:var(--shadow)
    }
    .msg{display:flex;gap:10px;margin:12px 2px}
    .msg .avatar{
      width:32px;height:32px;border-radius:50%;flex:0 0 32px;
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      background:#e9eef7;color:#274472;font-weight:700;border:1px solid var(--border)
    }
    .msg .avatar img{width:32px;height:32px;object-fit:cover;border-radius:50%}
    .bubble{max-width:75%;padding:12px 14px;border-radius:14px;position:relative;border:1px solid var(--border)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .bot .bubble{background:var(--bubble-bot);border-top-left-radius:6px}
    .user{justify-content:flex-end}
    .user .bubble{background:var(--bubble-user);border-top-right-radius:6px}
    .message.user {
    text-align: right;       /* cƒÉn ph·∫£i */
    align-self: flex-end;    /* n·∫øu d√πng flexbox */
    background: #ffecec;     /* m√†u n·ªÅn nh·∫°t h∆°n cho d·ªÖ ph√¢n bi·ªát */
}
.msg.user{ 
  justify-content: flex-end; 
  flex-direction: row-reverse;  /* ƒë·∫£o th·ª© t·ª±: avatar ra ngo√†i b√™n ph·∫£i */
}
.user .avatar{ 
  display: flex;                /* ƒë·∫£m b·∫£o avatar hi·ªÉn th·ªã */
}
.user .bubble{ 
  border-top-right-radius: 6px; /* bo g√≥c cho ƒë·∫πp */
}

    .tools{display:flex;gap:8px;margin-top:6px}
    .btnx{
      font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:8px;
      background:#f4f7fb;color:#2a3a4f;cursor:pointer
    }
    .btnx:hover{background:#eef2f9}

    /* Quick prompts */
    .prompts{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .prompts .qp{
      background:#f4f7fb;border:1px solid var(--border);
      padding:6px 10px;border-radius:999px;cursor:pointer;font-size:14px;color:var(--text)
    }
    .prompts .qp:hover{background:var(--accent-1);color:#fff;border-color:var(--accent-1)}

    /* Input bar */
    .bar{display:flex;gap:10px;margin-top:12px}
    textarea{
      flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:#fff;color:var(--text);resize:vertical;min-height:44px;max-height:160px;
      box-shadow:0 1px 0 rgba(17,24,39,.03) inset
    }
    button.send{
      padding:12px 16px;border-radius:12px;border:1px solid #e7c7bc;cursor:pointer;
      background:var(--accent-2);color:white;font-weight:700;box-shadow:0 2px 0 rgba(0,0,0,.04)
    }
    button.send:hover{background:#d64f1f}
    button:disabled{opacity:.6;cursor:not-allowed}
    .footer{margin-top:12px;font-size:12px;color:var(--muted);text-align:center}

    /* Typing dots */
    .typing{display:inline-block}
    .typing span{display:inline-block;width:6px;height:6px;margin:0 2px;background:#9fb2c9;border-radius:50%;opacity:.6;animation:blink 1.2s infinite}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

    @media (max-width:640px){.bubble{max-width:85%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <img class="logo" src="logo.png" alt="Edison Logo" />
      <div>
        <div class="title">CPD Coach</div>
        <div class="subtitle">Tr·ª£ l√Ω n·ªôi b·ªô Edison v·ªÅ quy tr√¨nh, rubric, timeline, bi·ªÉu m·∫´u CPD.</div>
      </div>
      <div class="badge">Edison ‚Ä¢ Internal</div>
    </div>

    <div id="chat" class="chat"></div>

    <!-- QUICK PROMPTS -->
    <div class="prompts">
      <button class="qp">Quy tr√¨nh CPD</button>
      <button class="qp">SEL l√† g√¨?</button>
      <button class="qp">Timeline ƒë√°nh gi√°</button>
      <button class="qp">H∆∞·ªõng d·∫´n rubric</button>
    </div>

    <div class="bar">
      <textarea id="inp" placeholder="Nh·∫≠p c√¢u h·ªèi‚Ä¶ (Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng)"></textarea>
      <button id="btn" class="send">G·ª≠i</button>
    </div>
    <div class="footer">¬© Edison Schools ‚Äì CPD Coach. H·ªôi tho·∫°i ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô, API key ƒë∆∞·ª£c b·∫£o v·ªá qua serverless proxy.</div>
  </div>

  <script>
    const ENDPOINT = "/.netlify/functions/chat";
    const $chat = document.getElementById('chat');
    const $inp  = document.getElementById('inp');
    const $btn  = document.getElementById('btn');

    const KEY = 'cpd_chat_history_light_v2';
    const history = JSON.parse(localStorage.getItem(KEY) || '[]');

    function saveHistory(){ localStorage.setItem(KEY, JSON.stringify(history)); }
    function timeStr(iso){ return new Date(iso).toLocaleString(); }
    function esc(s){return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}

    // Bullet & xu·ªëng d√≤ng c∆° b·∫£n
    function formatReply(text){
  let html = (text || "").replace(/\n/g,'<br>');
  // th√™m üëâ tr∆∞·ªõc n·ªôi dung bullet
  html = html.replace(/^- (.*)$/gm,'<li>üëâ $1</li>');
  html = html.replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>');
  return html;
}


    // Render bubble; user -> escape; bot -> html (ƒë√£ format)
    function bubbleHTML(role, content, t){
      const side = role === 'user' ? 'user' : 'bot';
      const ava  = side === 'bot'
        ? `<div class="avatar"><img src="bot.png" alt="Bot"></div>`
        : `<div class="avatar"><img src="user.png" alt="User"></div>`;

      const tools = side==='bot'
        ? `<div class="tools"><button class="btnx" data-copy="${esc(content)}">Copy</button></div>`
        : '';

      const safeContent = side==='user' ? esc(content) : content; // bot cho ph√©p HTML ƒë√£ format

      return `
      <div class="msg ${side}">
        ${ava}
        <div>
          <div class="bubble">${safeContent}</div>
          ${tools}
          <div class="meta">${timeStr(t)}</div>
        </div>
      </div>`;
    }

    function render(){
      $chat.innerHTML = history.map(m => bubbleHTML(m.role, m.role==='user' ? esc(m.content) : formatReply(m.content), m.t)).join('');
      $chat.scrollTop = $chat.scrollHeight;
    }

    function addMessage(role, content){
      const item = { role, content, t: new Date().toISOString() };
      history.push(item); saveHistory(); render();
    }

    function showTyping(){
      const t = new Date().toISOString();
      const html = bubbleHTML('assistant', `<span class="typing"><span></span><span></span><span></span></span>`, t);
      $chat.insertAdjacentHTML('beforeend', html);
      $chat.scrollTop = $chat.scrollHeight;
      return t;
    }

    function replaceLastBotBubbleHTML(html){
      const nodes = $chat.querySelectorAll('.msg.bot .bubble');
      for(let i=nodes.length-1;i>=0;i--){
        if(nodes[i].innerHTML.includes('typing')){ nodes[i].innerHTML = html; break; }
      }
      $chat.scrollTop = $chat.scrollHeight;
    }

    // Typewriter ‚Äúgi·∫£ streaming‚Äù
    function typeOutHTML(finalHTML, bubbleNode, speed=8){
      // g√µ d·∫ßn d∆∞·ªõi d·∫°ng text ƒë·ªÉ m∆∞·ª£t, r·ªìi ch·ªët b·∫±ng HTML ƒë√£ format
      const plain = finalHTML
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<\/?ul>|<\/?li>/gi, '')
        .replace(/&nbsp;/g,' ');
      let i=0;
      return new Promise(resolve=>{
        const timer=setInterval(()=>{
          i++;
          bubbleNode.innerHTML = esc(plain.slice(0,i)).replace(/\n/g,'<br>');
          $chat.scrollTop = $chat.scrollHeight;
          if(i>=plain.length){ clearInterval(timer); bubbleNode.innerHTML = finalHTML; resolve(); }
        }, speed);
      });
    }

    // Copy-to-clipboard
    $chat.addEventListener('click', e=>{
      const btn = e.target.closest('.btnx');
      if(!btn) return;
      const txt = btn.getAttribute('data-copy') || '';
      navigator.clipboard.writeText(txt).then(()=>{
        btn.textContent='ƒê√£ copy'; setTimeout(()=>btn.textContent='Copy',1200);
      });
    });

    // Quick prompts
    document.querySelectorAll('.prompts .qp').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $inp.value = btn.textContent;
        send();
      });
    });

    // Kh·ªüi t·∫°o l·ªùi ch√†o / render l·ªãch s·ª≠
    if (!history.length) {
      addMessage('assistant','Ch√†o b·∫°n üëã M√¨nh l√† CPD Coach Edison (Light). B·∫°n mu·ªën h·ªèi g√¨ v·ªÅ CPD h√¥m nay?');
    } else {
      render();
    }

    // === SEND (JSON + typewriter) ===
async function send(){
  // 1) L·∫•y & l√†m s·∫°ch input ng∆∞·ªùi d√πng
  let text = $inp.value.trim();
  if (!text) return;
  // G·ªôp m·ªçi newline th√†nh 1 kho·∫£ng tr·∫Øng, tr√°nh t·ª± xu·ªëng d√≤ng v·ªõi c√¢u ng·∫Øn
  text = text.replace(/\s*\n\s*/g, ' ').replace(/\s{2,}/g, ' ');

  // 2) Kh√≥a UI v√† hi·ªÉn th·ªã tin ng∆∞·ªùi d√πng + typing
  $inp.value = '';
  $inp.focus();
  $btn.disabled = true;
  $inp.disabled = true;

  addMessage('user', text);
  showTyping();

  try{
    // 3) G·ªçi server (tr·∫£ JSON { reply })
    const res = await fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: history })
    });
    if (!res.ok) throw new Error('Server tr·∫£ tr·∫°ng th√°i ' + res.status);

    const data = await res.json();
    const finalText = data.reply || '[Kh√¥ng c√≥ ph·∫£n h·ªìi]';
    const finalHTML = formatReply(finalText); // xu·ªëng d√≤ng + bullet üëâ

    // 4) G√µ d·∫ßn v√†o bubble ‚Äúƒëang g√µ‚Ä¶‚Äù
    const nodes = $chat.querySelectorAll('.msg.bot .bubble');
    const bubble = nodes[nodes.length - 1];
    await typeOutHTML(finalHTML, bubble, 8); // ch·ªânh t·ªëc ƒë·ªô t·∫°i ƒë√¢y (ms/char)

    // 5) L∆∞u h·ªôi tho·∫°i (d·∫°ng text th√¥, l·∫ßn sau render() s·∫Ω format l·∫°i)
    addMessage('assistant', finalText);
  } catch (err) {
    replaceLastBotBubbleHTML('‚ö†Ô∏è L·ªói: ' + esc(err.message));
  } finally {
    // 6) M·ªü kh√≥a UI
    $btn.disabled = false;
    $inp.disabled = false;
  }
}


    // Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng
    $btn.addEventListener('click', send);
    $inp.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
  </script>
</body>
</html>
